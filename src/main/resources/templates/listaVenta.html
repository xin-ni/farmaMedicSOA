<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <link th:href="@{/paginas/css/estilosAdmin.css}" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link th:href="@{/paginas/css/listaCategorias.css}" rel="stylesheet" type="text/css" />
    <link th:href="@{/paginas/css/modal.css}" rel="stylesheet" type="text/css" />

    <meta charset="UTF-8">
    <title>Formulario de Registro de Venta</title>
</head>

<body>
    <div th:replace="header.html"></div>
    <div class="contenedorInferior">
        <div th:replace="navbar.html"></div>
        <h1>Administrar Ventas</h1>
        <table>
            <thead>
                <tr>
                    <th>ID Venta</th>
                    <th>ID Vendedor</th>
                    <th>Nombre Cliente</th>
                    <th>Fecha Registro</th>
                    <th>Total Venta</th>
                </tr>
            </thead>
            <tbody>
                <!-- Iterar sobre la lista de ventas y mostrar los detalles -->
                <tr th:each="venta : ${ventas}">
                    <td th:text="${venta.idVenta}"></td>
                    <td th:text="${venta.vendedor.nombres}"></td>
                    <td th:text="${venta.nombreCliente}"></td>
                    <td th:text="${#dates.format(venta.fechaRegistro, 'dd-MM-yyyy')}"></td>
                <td id="totalVenta" th:text="${venta.totalVenta}"></td>
            </tr>
        </tbody>
    </table>
   
    <button onclick="abrirModalVentas()">Agregar venta</button>

  
    <div id="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
        <div style="background-color: white; width: 80%; max-width: 600px; margin: 100px auto; padding: 20px;">
            <h1>Registro de Venta</h1>
            <form th:action="@{/entity/venta/guardar}" method="post">
                <h2>Registrar Venta</h2>
                <div>
                    <label for="trabajador">Trabajador:</label>
                    <select id="trabajador" name="trabajador" required>
                        <option value="">Selecciona un trabajador</option>
                        <!-- Iterar sobre la lista de empleados y mostrarlos en el combo -->
                        <option th:each="empleado : ${empleados}" th:value="${empleado.nombres}" th:text="${empleado.nombres}"></option>
                    </select>
                </div>
                <div>
                    <label for="nombreCliente">Nombre del Cliente:</label>
                    <input type="text" id="nombreCliente" name="nombreCliente" required>
                </div>
                <div>
                    <label for="fechaVenta">Fecha de Venta:</label>
                    <input type="date" id="fechaVenta" name="fechaVenta" value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" required>
                </div>
    
                <h2>Productos</h2>
                <div>
                    <label for="idProducto">Producto:</label>
                    <select id="idProducto" name="idProducto" required onchange="mostrarPrecioVenta()">
                        <option value="">Selecciona un producto</option>
                        <!-- Iterar sobre la lista de productos y mostrarlos en el combo -->
                        <option th:each="producto : ${productos}" th:value="${producto.idProducto}" th:data-precio-venta="${producto.precioVentaProducto}" th:text="${producto.nombreProducto}"></option>
                    </select>
                </div>
                <div>
                    <label for="fechaVenta">Precio Venta:</label>
                    <span style="height: 360px; width: 200px; background-color: gray;" id="precioVentaSpan" required></span>
                </div>
                <div>
                    <label for="fechaVenta">Cantidad:</label>
                    <input type="text" id="cantidad" oninput="calcularTotal()" required>
                </div>
                <!-- Campitos del total -->
                <h2>Total</h2>
                <div>
                    <label for="total">Total:</label>
                    <input type="text" id="total" name="total" readonly>
                </div>
                
    
                <!-- Botón de registrar -->
                <button type="submit">Registrar</button>
            </form>
            <button onclick="cerrarModalVentas()">Cerrar Modal</button>
        </div>
    </div>
    
</div>
    <script>
        // Contador para dar un identificador único a cada grupo de campos de productos
        let productoCounter = 1;

        // Función para agregar un nuevo grupo de campos de productos
        function agregarProducto() {
            const productosContainer = document.getElementById("productosContainer");

            const nuevoProducto = document.createElement("div");
            nuevoProducto.className = "producto";

            nuevoProducto.innerHTML = `
                <label for="nombreProducto">Nombre del Producto:</label>
                <input type="text" class="nombreProducto" name="nombreProducto" required>
                <label for="precio">Precio:</label>
                <input type="number" class="precio" name="precio" required>
                <label for="cantidad">Cantidad:</label>
                <input type="number" class="cantidad" name="cantidad" required>
                <label for="stock">Stock:</label>
                <input type="number" class="stock" name="stock" required>
                <button type="button" onclick="agregarProducto()">+</button>
            `;

            productosContainer.appendChild(nuevoProducto);
        }

        document.getElementById("productosContainer").addEventListener("change", calcularTotal);

        function calcularTotal() {
            const precios = document.querySelectorAll(".precio");
            const cantidades = document.querySelectorAll(".cantidad");

            let total = 0;
            for (let i = 0; i < precios.length; i++) {
                total += parseFloat(precios[i].value) * parseInt(cantidades[i].value);
            }

            document.getElementById("total").value = total;
        }

        function abrirModalVentas() {
            document.getElementById("modal").style.display = "block";
        }

        function cerrarModalVentas() {
            document.getElementById("modal").style.display = "none";
        }
    </script>
   <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Obtener el elemento span que contiene el total de venta
        const totalVentaElement = document.getElementById('totalVenta');

        // Obtener el valor numérico del total de venta
        const totalVenta = parseFloat(totalVentaElement.textContent);

        // Formatear el valor como moneda peruana (Soles)
        const totalVentaFormateado = new Intl.NumberFormat('es-PE', {
            style: 'currency',
            currency: 'PEN'
        }).format(totalVenta);

        // Asignar el valor formateado de moneda al elemento span
        totalVentaElement.textContent = totalVentaFormateado;
    });
</script>


<script th:inline="javascript">
    function mostrarPrecioVenta() {

        const selectProducto = document.getElementById("idProducto");
        const idProductoSeleccionado = selectProducto.value;


        const precioVentaSpan = document.getElementById("precioVentaSpan");


        if (idProductoSeleccionado === "") {
            precioVentaSpan.textContent = "";
        } else {

            const precioVentaProducto = selectProducto.options[selectProducto.selectedIndex].dataset.precioVenta;

            // Formatear el precioVentaProducto como moneda peruana
            const formatter = new Intl.NumberFormat("es-PE", {
                style: "currency",
                currency: "PEN",
            });
            const precioVentaFormateado = formatter.format(precioVentaProducto);

            precioVentaSpan.textContent =precioVentaFormateado;
            calcularTotal();
        }
    }

    function calcularTotal() {

        const cantidadInput = document.getElementById("cantidad");
        const cantidad = cantidadInput.value;


        const selectProducto = document.getElementById("idProducto");
        const precioVentaProducto = selectProducto.options[selectProducto.selectedIndex].dataset.precioVenta;


        const total = cantidad * precioVentaProducto;

        const formatter = new Intl.NumberFormat("es-PE", {
            style: "currency",
            currency: "PEN",
        });
        const totalFormateado = formatter.format(total);

        const totalInput = document.getElementById("total");
        totalInput.value = totalFormateado;
    }
</script>
</body>
</html>